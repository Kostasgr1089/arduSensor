{% extends 'base.html' %}
{% block title %}History{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sensor Data History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0"></script>
</head>
<body>
   
    <div class="container mt-4">
        <h2>Sensor Data History</h2>

        <!-- Device Selection -->
        <form id="device-form">
            <label for="device-select">Select Device:</label>
            <select name="device" id="device-select" class="form-select w-auto d-inline">
                <option value="all" {% if selected_device == 'all' %}selected{% endif %}>All Devices</option>
                {% for device_id in device_ids %}
                    <option value="{{ device_id }}" {% if selected_device == device_id %}selected{% endif %}>{{ device_id }}</option>
                {% endfor %}
            </select>
        </form>

        <!-- Time Interval Selection -->
        <div class="mt-3">
            <label for="time-interval">Select Time Interval:</label>
            <select id="time-interval" class="form-select w-auto d-inline">
                <option value="1d">Last Day</option>
                <option value="1w">Last Week</option>
                <option value="1m">Last Month</option>
                <option value="1y">Last Year</option>
                <option value="all">All</option>
            </select>
            <button id="submit-button" type="button" class="btn btn-primary ms-2">Submit</button>
        </div>

        <!-- Chart Canvas -->
        <canvas id="sensorChart" class="mt-4" width="400" height="200"></canvas>
    </div>

    <script>
        let chart;

        function fetchData() {
            const interval = document.getElementById('time-interval').value;
            const selectedDevice = document.getElementById('device-select').value;
            const cacheBuster = new Date().getTime();

            fetch(`/api/history/?interval=${interval}&device=${selectedDevice}&_=${cacheBuster}`, {
                headers: { 'x-requested-with': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.timestamps.length) {
                    updateChart(data.timestamps.reverse(), data.temperatures.reverse(), data.humidities.reverse(), selectedDevice);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function updateChart(labels, temperatures, humidities, deviceId) {
            const ctx = document.getElementById('sensorChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `Temperature (Â°C) - ${deviceId}`,
                            data: temperatures,
                            borderColor: 'rgba(255, 99, 132, 1)',  // Red color for temperature
                            fill: false
                        },
                        {
                            label: `Humidity (%) - ${deviceId}`,
                            data: humidities,
                            borderColor: 'rgba(54, 162, 235, 1)',  // Blue color for humidity
                            fill: false,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,  // Use built-in chart legend
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Handle device selection change
        document.getElementById('device-select').addEventListener('change', fetchData);

        // Handle submit button click
        document.getElementById('submit-button').addEventListener('click', fetchData);

        // Initial data fetch on page load
        window.onload = fetchData;
    </script>
</body>
</html>
{% endblock %}
